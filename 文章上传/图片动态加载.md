# å›¾ç‰‡åŠ¨æ€åŠ è½½

ğŸ¦ˆå®ç°åœ¨ä½œå“å±•ç¤ºå’Œå›¾ç‰‡å±•ç¤ºç»„ä»¶ä¸­

- ç»ƒä¹ ç”Ÿå‘½å‘¨æœŸ
- é•¿åˆ—è¡¨æ¸²æŸ“ï¼Œæ»‘åŠ¨åº•éƒ¨è¯·æ±‚æ¸²æŸ“åˆ—è¡¨  (ç±»ä¼¼insçš„æµè§ˆå›¾ç‰‡)   æ–‡ç« é¡µä¹Ÿå¯ä»¥ä½¿ç”¨



## ä¸€ã€åŸºæœ¬åŸç†

å½“åç«¯ä¸€æ¬¡è¿”å›å¤§é‡æ•°æ®æ—¶ï¼Œé¡µé¢æ˜¾ç¤ºæœ‰é™ï¼Œæ¯”å¦‚ä¸€æ¬¡è¿”å›å¤§é‡å›¾ç‰‡ï¼Œé¦–å±å³åŠ è½½æ‰€æœ‰å›¾ç‰‡ï¼ˆæ— è®ºè¿™äº›å›¾ç‰‡æœ‰æ²¡æœ‰è¢«ç”¨æˆ·çœ‹åˆ°ï¼‰ï¼Œé‚£æ— ç–‘æ˜¯æ—¢æµªè´¹ç½‘ç»œèµ„æºï¼Œåˆå½±å“ä½“éªŒï¼Œæ‰€ä»¥é‡‡ç”¨å›¾ç‰‡æ»šåŠ¨æ‡’åŠ è½½ï¼Œæé«˜å‰ç«¯æ€§èƒ½ã€‚

åˆ¤æ–­é¡µé¢æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨è¿›è¡Œæ•°æ®åŠ è½½ã€‚

![img](å›¾ç‰‡åŠ¨æ€åŠ è½½.assets/df498a00-8ae3-11eb-ab90-d9ae814b240d.png)

åˆ¤æ–­é¡µé¢åˆ°è¾¾åº•éƒ¨çš„æ–¹æ³•ï¼š

- `scrollHeight`ï¼šå…ƒç´ å†…å®¹æ€»çš„é«˜åº¦ï¼ŒåŒ…å«æº¢å‡ºéƒ¨åˆ†ã€‚scrollHeightè¡¨ç¤º`body`æ‰€æœ‰å…ƒç´ çš„æ€»é•¿åº¦(åŒ…æ‹¬bodyå…ƒç´ è‡ªèº«çš„padding)
- `scrollTop`ï¼šæ»šåŠ¨è§†çª—çš„é«˜åº¦è·ç¦»`window`é¡¶éƒ¨çš„è·ç¦»ï¼Œå®ƒä¼šéšç€å¾€ä¸Šæ»šåŠ¨è€Œä¸æ–­å¢åŠ ï¼Œåˆå§‹å€¼æ˜¯0ï¼Œå®ƒæ˜¯ä¸€ä¸ªå˜åŒ–çš„å€¼ã€‚ğŸ¦ˆè§†å£é¡¶éƒ¨åˆ°å…ƒç´ å†…å®¹é¡¶éƒ¨çš„è·ç¦»ã€‚
- `clientHeight`:å®ƒæ˜¯ä¸€ä¸ªå®šå€¼ï¼Œè¡¨ç¤ºå±å¹•å¯è§†åŒºåŸŸçš„é«˜åº¦ï¼›

**è§¦åº•å…¬å¼**

```js
scrollTop + clientHeight >= scrollHeight
```



## äºŒã€æ•´ä½“å®ç°é€»è¾‘

**1. åˆå§‹åŒ–æ•°æ®**

å°†æ•°æ®åˆ†ä¸ºpageCounté¡µï¼Œè®°å½•å½“å‰é¡µæ•°page

```js
const [data, setData] = useState({ list: [], page: 0, pageCount: 1 })
```

è¯·æ±‚æ•°æ®

```js
/* åˆå§‹åŒ–è¯·æ±‚æ•°æ® */
useEffect(() => {
  getData()
}, [])
```

**2. å®šä¹‰é¡µé¢æ»šåŠ¨äº‹ä»¶**

```js
  useEffect(() => {
    document.addEventListener('scroll', handerScroll)
  }, [list]);

  /* -----è‡ªå®šä¹‰äº‹ä»¶---- */
  /* æ§åˆ¶æ»šåŠ¨æ¡æ»šåŠ¨ */
  const handerScroll = (e) => {
    // console.log('æ­£åœ¨æ»šåŠ¨')
  }
```



**3. åˆ°è¾¾åº•éƒ¨è·å–æ•°æ®**

åˆ¤æ–­æ˜¯å¦åˆ°è¾¾é¡µé¢åº•éƒ¨ï¼Œåˆ°è¾¾åº•éƒ¨åï¼Œå›è°ƒå‡½æ•°`scrolltolower` 

```js
const handerScrolltolower = (e) => {
  // console.log('åˆ°åº•å°±è¾“å‡º', scrolltolower)
  const { scrollHeight, scrollTop, offsetHeight } = e.target.scrollingElement
  console.log('è·æ•°æ®æœ€ä½ç«¯è·ç¦»', offsetHeight - scrollTop + 178);
  if (scrollHeight === scrollTop + offsetHeight) { /* åˆ°è¾¾å®¹å™¨åº•éƒ¨ä½ç½® */
    scrolltolower && scrolltolower()
  }
}

// çˆ¶ç»„ä»¶ä¸­å®šä¹‰äº†å›è°ƒå‡½æ•°çš„å¤„ç†å‡½æ•°
const handerScrolltolower = () => {
  console.log('scrollå·²ç»åˆ°åº•éƒ¨')
  getData()
}
```

**4. ä¼˜åŒ–å¤„ç†**

å¯¹æ»šåŠ¨å¤„ç†å‡½æ•°åšé˜²æŠ–å¤„ç†

```js
export function debounce(fn, time) {
  let timer = null;
  return function (...arg) {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => {
      fn.apply(this, arg);
    }, time);
  };
}

/* æ§åˆ¶æ»šåŠ¨æ¡æ»šåŠ¨ */
const handerScroll = (e) => {
  // console.log('â­æµ‹è¯•è¾“å‡º')
  scroll && scroll(e)
  debounce(handerScrolltolower(e), 200)
}
```

## ä¸‰ã€æ•´ä½“ä»£ç 

**Indexç»„ä»¶**

```js
import React, { useEffect, useState } from 'react'
import { listData } from '../utils/mock'
import ScrollView from './ScrollView';

// ğŸ¦ˆè¯·æ±‚æ•°æ®ï¼Œé»˜è®¤é¡µæ•° page ä¸º0ï¼Œè¯·æ±‚æ•°æ®æ—¶ page+1ï¼Œç„¶ååœ¨æ€»æ•°æ®listDatä¸­æˆªå–é‡‡ç”¨sliceå‡½æ•°æˆªå–æ•°æ®
const fetchData = (page) => {
  return new Promise((resolve) => {
    resolve({
      ...listData,
      page,
      list: listData.list.slice(5 * (page - 1), 5 * page)
    })
  })
}

const Camera = () => {
  console.log('----è·å–æ•°æ®-----')
  const [data, setData] = useState({ list: [], page: 0, pageCount: 1 }) /* è®°å½•åˆ—è¡¨æ•°æ® */
  /* è¯·æ±‚æ•°æ® */
  const getData = async () => {
    if (data.page === data.pageCount) return console.log('æ²¡æœ‰æ•°æ®äº†ï½')
    const res = await fetchData(data.page + 1)
    const payload = {
      ...res,
      list: res.page === 1 ? res.list : data.list.concat(res.list)
    }
    // console.log(payload, 'payloadpayloadpayload')
    console.log(res);
    if (res.code === 0) setData(payload)
  }
  /* æ»šåŠ¨åˆ°åº•éƒ¨è§¦å‘ ğŸ¦ˆåˆ°åº•å,å­ç»„ä»¶ å›è°ƒå‡½æ•°ç„¶åå†æ¬¡è¯·æ±‚æ•°æ® */
  const handerScrolltolower = () => {
    console.log('scrollå·²ç»åˆ°åº•éƒ¨')
    getData()
  }

  /* åˆå§‹åŒ–è¯·æ±‚æ•°æ® */
  useEffect(() => {
    getData()
  }, [])


  return <ScrollView
      data={data}  /* Item æ¸²æŸ“çš„å•å…ƒç»„ä»¶ */
      scroll={() => { }}
      scrolltolower={handerScrolltolower}
    />
}
export default Camera
```

**ScrollViewç»„ä»¶**

```js
import React from 'react'
import { useEffect } from 'react';
import Item from './Item'
import style from './index.module.scss'

export function debounce(fn, time) {
  let timer = null;
  return function (...arg) {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => {
      fn.apply(this, arg);
    }, time);
  };
}

export default function ScrollView(props) {
  const { data, scroll, scrolltolower } = props;
  const list = data.list

  useEffect(() => {
    document.addEventListener('scroll', handerScroll)
  }, [list]);

  /* -----è‡ªå®šä¹‰äº‹ä»¶---- */
  /* æ§åˆ¶æ»šåŠ¨æ¡æ»šåŠ¨ */
  const handerScroll = (e) => {
    // console.log('â­æµ‹è¯•è¾“å‡º')
    scroll && scroll(e)
    debounce(handerScrolltolower(e), 200)
  }
  /* åˆ¤æ–­æ»šåŠ¨æ¡æ˜¯å¦åˆ°åº•éƒ¨ */
  // scrollHeight å…ƒç´ å†…å®¹é«˜åº¦(åŒ…æ‹¬ç”±äºæº¢å‡ºå¯¼è‡´çš„è§†å›¾ä¸­ä¸å¯è§å†…å®¹ã€‚)
  // scrollTop å…ƒç´ çš„å†…å®¹é¡¶éƒ¨ï¼ˆå·èµ·æ¥çš„ï¼‰åˆ°å®ƒçš„è§†å£å¯è§å†…å®¹ï¼ˆçš„é¡¶éƒ¨ï¼‰çš„è·ç¦»
  // offsetHeight 
  const handerScrolltolower = (e) => {
    // console.log('åˆ°åº•å°±è¾“å‡º', scrolltolower)
    const { scrollHeight, scrollTop, offsetHeight } = e.target.scrollingElement
    console.log('è·æ•°æ®æœ€ä½ç«¯è·ç¦»', offsetHeight - scrollTop + 178);
    if (scrollHeight === scrollTop + offsetHeight) { /* åˆ°è¾¾å®¹å™¨åº•éƒ¨ä½ç½® */
      scrolltolower && scrolltolower()
    }
  }

  return <div className={style.listBox}>
    {
      list.map((item, index) => (
        <Item key={index} item={item} />
      ))
    }
  </div>

}
```

