# å…³äºthis

- å‡½æ•°çš„è°ƒç”¨æ–¹å¼å†³å®šäº†thisçš„å€¼
- thisä¸å¯ä»¥åœ¨æ‰§è¡ŒæœŸé—´è¢«èµ‹å€¼

**å…¨å±€ä¸Šä¸‹æ–‡**

æ— è®ºæ˜¯å¦åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œåœ¨å…¨å±€æ‰§è¡Œç¯å¢ƒä¸­ï¼ˆåœ¨ä»»ä½•å‡½æ•°ä½“å¤–éƒ¨ï¼‰`this` éƒ½æŒ‡å‘å…¨å±€å¯¹è±¡ã€‚

**å‡½æ•°ä¸Šä¸‹æ–‡**

- åœ¨å‡½æ•°å†…éƒ¨ï¼Œ`this`çš„å€¼å–å†³äºå‡½æ•°è¢«è°ƒç”¨çš„æ–¹å¼ã€‚
- éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œè‹¥å‡½æ•°ä¸­æœªè®¾å®šthisï¼Œåˆ™thisé»˜è®¤ä¸ºå…¨å±€ã€‚
- æŠŠ`this`çš„å€¼ä»ä¸€ä¸ªç¯å¢ƒä¼ åˆ°å¦ä¸€ä¸ªï¼Œå°±è¦ç”¨ `call` æˆ–è€…`apply` æ–¹æ³•

**ç±»ä¸Šä¸‹æ–‡**

- åœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œ`this` æ˜¯ä¸€ä¸ªå¸¸è§„å¯¹è±¡ã€‚ç±»ä¸­æ‰€æœ‰éé™æ€çš„æ–¹æ³•éƒ½ä¼šè¢«æ·»åŠ åˆ° `this` çš„åŸå‹ä¸­ï¼š

**æ´¾ç”Ÿç±»**

- åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨`super()`ä¼šç”Ÿæˆä¸€ä¸ª`this`ç»‘å®š
- æ´¾ç”Ÿç±»ä¸èƒ½åœ¨è°ƒç”¨ `super()` ä¹‹å‰è¿”å›ï¼Œé™¤éå…¶æ„é€ å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ–è€…æ ¹æœ¬æ²¡æœ‰æ„é€ å‡½æ•°ã€‚

**å®ä¾‹**

- å‡½æ•°ä¸Šä¸‹æ–‡çš„this

  ```js
  // å¯¹è±¡å¯ä»¥ä½œä¸º bind æˆ– apply çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼Œå¹¶ä¸”è¯¥å‚æ•°å°†ç»‘å®šåˆ°è¯¥å¯¹è±¡ã€‚---bindæ”¹å˜thisæŒ‡å‘
  var obj = {a: 'Custom'};
  
  // å£°æ˜ä¸€ä¸ªå˜é‡ï¼Œå¹¶å°†è¯¥å˜é‡ä½œä¸ºå…¨å±€å¯¹è±¡ window çš„å±æ€§ã€‚
  var a = 'Global';
  
  function whatsThis() {
    return this.a;  // this çš„å€¼å–å†³äºå‡½æ•°è¢«è°ƒç”¨çš„æ–¹å¼
  }
  
  whatsThis();          // 'Global' å› ä¸ºåœ¨è¿™ä¸ªå‡½æ•°ä¸­ this æ²¡æœ‰è¢«è®¾å®šï¼Œæ‰€ä»¥å®ƒé»˜è®¤ä¸º å…¨å±€/ window å¯¹è±¡
  whatsThis.call(obj);  // 'Custom' å› ä¸ºå‡½æ•°ä¸­çš„ this è¢«è®¾ç½®ä¸º obj
  whatsThis.apply(obj); // 'Custom' å› ä¸ºå‡½æ•°ä¸­çš„ this è¢«è®¾ç½®ä¸º obj
  ```

- thiså’Œå¯¹è±¡è½¬æ¢

  è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°addå’Œä¸€ä¸ªå¯¹è±¡oï¼Œæˆ‘ä»¬è°ƒç”¨å‡½æ•°æ—¶ï¼Œé‡‡ç”¨`call`ã€`apply`æ–¹æ³•ç»‘å®šthisä¸ºå¯¹è±¡oï¼Œå³ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ç»‘å®šçš„åœ°æ–¹ã€‚

  ```js
  function add(c, d) {
    return this.a + this.b + c + d;
  }
  
  var o = {a: 1, b: 3};
  
  // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨ä½œâ€œthisâ€çš„å¯¹è±¡
  // å…¶ä½™å‚æ•°ç”¨ä½œå‡½æ•°çš„å‚æ•°
  add.call(o, 5, 7); // 16
  
  // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨ä½œâ€œthisâ€çš„å¯¹è±¡
  // ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„ä¸¤ä¸ªæˆå‘˜ç”¨ä½œå‡½æ•°å‚æ•°
  add.apply(o, [10, 20]); // 34
  ```

  åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹ä½¿ç”¨ `call` å’Œ `apply` æ—¶ï¼Œå¦‚æœç”¨ä½œ `this` çš„å€¼ä¸æ˜¯å¯¹è±¡ï¼Œåˆ™ä¼šè¢«å°è¯•è½¬æ¢ä¸ºå¯¹è±¡ã€‚ä¸æ˜¯å¯¹è±¡çš„å€¼ä¼šè‡ªåŠ¨è½¬æˆå¯¹è±¡ã€‚åŸå§‹å€¼`7 str true`ä¹Ÿä¼šè¢«è½¬æˆåŸå§‹å€¼åŒ…è£…ç±»å‹ã€‚

  ```js
  function bar() {
    console.log(Object.prototype.toString.call(this));
  }
  
  bar.call(7);     // [object Number]
  bar.call('foo'); // [object String]
  bar.call(undefined); // [object global]
  ```

- bindæ–¹æ³•

  è°ƒç”¨`f.bind(someObject)`ä¼šåˆ›å»ºä¸€ä¸ªä¸`f`å…·æœ‰ç›¸åŒå‡½æ•°ä½“å’Œä½œç”¨åŸŸçš„å‡½æ•°ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªæ–°å‡½æ•°ä¸­ï¼Œ`this`å°†æ°¸ä¹…åœ°è¢«ç»‘å®šåˆ°äº†`bind`çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ— è®ºè¿™ä¸ªå‡½æ•°æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚

  ğŸ¦ˆ`bind()`æ–¹æ³•ï¼Œä¼šç”Ÿæˆä¸€ä¸ªå’Œè°ƒç”¨è¯¥æ–¹æ³•çš„å‡½æ•°ä¸€æ ·çš„å‡½æ•°ï¼Œåªæ˜¯æŠŠthisç»‘å®šåˆ°äº†ç¬¬ä¸€ä¸ªå‚æ•°ä¸Šã€‚

  ```js
  function f(){
    return this.a;
  }
  
  var g = f.bind({a:"azerty"});
  console.log(g()); // azerty
  
  var h = g.bind({a:'yoo'}); // bind åªç”Ÿæ•ˆä¸€æ¬¡ï¼
  console.log(h()); // azerty
  
  var o = {a:37, f:f, g:g, h:h};
  console.log(o.a, o.f(), o.g(), o.h()); // 37, 37, azerty, azerty
  // o.aè°ƒç”¨å¯¹è±¡çš„å±æ€§ï¼Œç›´æ¥è¾“å‡º
  // o.f()ï¼Œå¯¹è±¡oè°ƒç”¨äº†å‡½æ•°f()ï¼Œæ‰€ä»¥è¿™é‡Œçš„thisæŒ‡å‘å¯¹è±¡oï¼Œaä¸ºå¯¹è±¡oçš„å±æ€§å€¼37
  // o.g(), o.h(),é‡‡ç”¨bindæ–¹æ³•ç»‘å®šäº†thisï¼Œæ‰€ä»¥è¿™é‡Œçš„thisæŒ‡å‘{a:"azerty"}ï¼Œå¹¶ä¸”åªå¯¹ç¬¬ä¸€æ¬¡ç»‘å®šæœ‰æ•ˆ
  ```

- ç®­å¤´å‡½æ•°

  åœ¨[ç®­å¤´å‡½æ•°](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions)ä¸­ï¼Œ`this`ä¸å°é—­è¯æ³•ç¯å¢ƒçš„`this`ä¿æŒä¸€è‡´ã€‚åœ¨å…¨å±€ä»£ç ä¸­ï¼Œå®ƒå°†è¢«è®¾ç½®ä¸ºå…¨å±€å¯¹è±¡ï¼š

  ```js
  var globalObject = this;
  var foo = (() => this);
  console.log(foo() === globalObject); // true
  ```

  æ³¨æ„ï¼šå¦‚æœå°†`this`ä¼ é€’ç»™`call`ã€`bind`ã€æˆ–è€…`apply`æ¥è°ƒç”¨ç®­å¤´å‡½æ•°ï¼Œå®ƒå°†è¢«å¿½ç•¥ã€‚

  åœ¨ç®­å¤´å‡½æ•°ä¸­ï¼Œthisçš„æŒ‡å‘ä¸ºå®ƒè¢«åˆ›å»ºæ—¶çš„ç¯å¢ƒã€‚

  ```js
  // åˆ›å»ºä¸€ä¸ªå«æœ‰ bar æ–¹æ³•çš„ obj å¯¹è±¡ï¼Œ
  // bar è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œ
  // è¿™ä¸ªå‡½æ•°è¿”å› thisï¼Œ
  // è¿™ä¸ªè¿”å›çš„å‡½æ•°æ˜¯ä»¥ç®­å¤´å‡½æ•°åˆ›å»ºçš„ï¼Œ
  // æ‰€ä»¥å®ƒçš„ this è¢«æ°¸ä¹…ç»‘å®šåˆ°äº†å®ƒå¤–å±‚å‡½æ•°çš„ thisã€‚
  // bar çš„å€¼å¯ä»¥åœ¨è°ƒç”¨ä¸­è®¾ç½®ï¼Œè¿™åè¿‡æ¥åˆè®¾ç½®äº†è¿”å›å‡½æ•°çš„å€¼ã€‚
  var obj = {
    bar: function() {
      var x = (() => this);
      return x;
    }
  };
  
  // ä½œä¸º obj å¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•æ¥è°ƒç”¨ barï¼ŒæŠŠå®ƒçš„ this ç»‘å®šåˆ° objã€‚
  // å°†è¿”å›çš„å‡½æ•°çš„å¼•ç”¨èµ‹å€¼ç»™ fnã€‚
  var fn = obj.bar();
  
  // ç›´æ¥è°ƒç”¨ fn è€Œä¸è®¾ç½® thisï¼Œ
  // é€šå¸¸ (å³ä¸ä½¿ç”¨ç®­å¤´å‡½æ•°çš„æƒ…å†µ) é»˜è®¤ä¸ºå…¨å±€å¯¹è±¡
  // è‹¥åœ¨ä¸¥æ ¼æ¨¡å¼åˆ™ä¸º undefined
  console.log(fn() === obj); // true
  
  // ä½†æ˜¯æ³¨æ„ï¼Œå¦‚æœä½ åªæ˜¯å¼•ç”¨ obj çš„æ–¹æ³•ï¼Œ
  // è€Œæ²¡æœ‰è°ƒç”¨å®ƒ
  var fn2 = obj.bar;
  // é‚£ä¹ˆè°ƒç”¨ç®­å¤´å‡½æ•°åï¼Œthis æŒ‡å‘ windowï¼Œå› ä¸ºå®ƒä» bar ç»§æ‰¿äº† thisã€‚
  console.log(fn2()() == window); // true
  ```

  ğŸ¦ˆåœ¨è¿™é‡Œï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡å†…çš„å±æ€§barè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°é‡Œçš„å†…å®¹ç”±ç®­å¤´å‡½æ•°å†³å®šï¼Œæ­¤æ—¶ç®­å¤´å‡½æ•°çš„thiså³å·²ç»ç»‘å®šä¸ºobjï¼Œåé¢å†æ¬¡ä½¿ç”¨thisæ—¶ï¼ŒthisæŒ‡å‘çš„å†…å®¹å°±ç”±objæ‰€å†³å®šã€‚---è¿™é‡Œæ²¡ææ˜ç™½ï¼Œobj.bar()æ—¶thisæŒ‡å‘äº†objï¼Œé‚£thisæ˜¯è¢«barå†³å®šçš„è¿˜æ˜¯objå†³å®šçš„ï¼Œobj.baræ—¶ï¼ŒthisæŒ‡å‘äº†windowï¼Œé‚£æ˜¯ä¸æ˜¯thiså°±æ˜¯ç”±baræ‰€å†³å®šã€‚ä¹Ÿå°±æ˜¯åœ¨å®šä¹‰ç®­å¤´å‡½æ•°åï¼Œå…¶thisçš„æŒ‡å‘æ˜¯ç”±baræ‰€å†³å®šã€‚

- ä½œä¸ºå¯¹è±¡çš„æ–¹æ³•

  å½“å‡½æ•°ä½œä¸ºå¯¹è±¡é‡Œçš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œ`this` è¢«è®¾ç½®ä¸ºè°ƒç”¨è¯¥å‡½æ•°çš„å¯¹è±¡ã€‚

  ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå½“ `o.f()` è¢«è°ƒç”¨æ—¶ï¼Œå‡½æ•°å†…çš„ `this` å°†ç»‘å®šåˆ° `o` å¯¹è±¡ã€‚

  ```js
  var o = {
    prop: 37,
    f: function() {
      return this.prop;
    }
  };
  
  console.log(o.f()); // 37
  
  // this çš„ç»‘å®šåªå—æœ€æ¥è¿‘çš„æˆå‘˜å¼•ç”¨çš„å½±å“
  o.b = {g: independent, prop: 42};
  console.log(o.b.g()); // 42
  // æŠŠä¸€ä¸ªæ–¹æ³•gå½“ä½œå¯¹è±¡o.bçš„å‡½æ•°è°ƒç”¨ã€‚åœ¨è¿™æ¬¡æ‰§è¡ŒæœŸé—´ï¼Œå‡½æ•°ä¸­çš„thiså°†æŒ‡å‘o.bã€‚
  // ğŸ¦ˆthisæŒ‡å‘æœ€è¿‘çš„å¼•ç”¨
  ```

- åŸå‹ä¸­çš„this

  å¦‚æœè¯¥æ–¹æ³•å­˜åœ¨äºä¸€ä¸ªå¯¹è±¡çš„åŸå‹é“¾ä¸Šï¼Œé‚£ä¹ˆ `this` æŒ‡å‘çš„æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„å¯¹è±¡ï¼Œå°±åƒè¯¥æ–¹æ³•å°±åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šä¸€æ ·ã€‚

  ```js
  var o = {
    f: function() {
      return this.a + this.b;
    }
  };
  var p = Object.create(o);
  p.a = 1;
  p.b = 4;
  
  console.log(p.f()); // 5
  ```

  ğŸ¦ˆpä¸­æ²¡æœ‰å±æ€§fï¼Œå‘åŸå‹ä¸­æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾å¼€å§‹çš„ä½ç½®å°±æ˜¯pï¼Œæ‰€ä»¥å‡½æ•°ä¸­çš„ `this` æŒ‡å‘`p`ï¼Œå› ä¸º`f`æ˜¯ä½œä¸º`p`çš„æ–¹æ³•è°ƒç”¨çš„ï¼Œæ‰€ä»¥å®ƒçš„`this`æŒ‡å‘äº†`p`ã€‚---ã€‹this çš„æŒ‡å‘æ˜¯pï¼Œå±æ€§å‡½æ•°ä»åŸå‹ä¸­è·å¾—çš„ã€‚

- getter ä¸ setter ä¸­çš„ `this`

- ä½œä¸ºæ„é€ å‡½æ•°

  å½“ä¸€ä¸ªå‡½æ•°ç”¨ä½œæ„é€ å‡½æ•°æ—¶ï¼ˆä½¿ç”¨[new](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/new)å…³é”®å­—ï¼‰ï¼Œå®ƒçš„`this`è¢«ç»‘å®šåˆ°æ­£åœ¨æ„é€ çš„æ–°å¯¹è±¡ã€‚

  ```js
  /*
   * æ„é€ å‡½æ•°è¿™æ ·å·¥ä½œï¼š
   *
   * function MyConstructor(){
   *   // å‡½æ•°å®ä½“å†™åœ¨è¿™é‡Œ
   *   // æ ¹æ®éœ€è¦åœ¨ this ä¸Šåˆ›å»ºå±æ€§ï¼Œç„¶åèµ‹å€¼ç»™å®ƒä»¬ï¼Œæ¯”å¦‚ï¼š
   *   this.fum = "nom";
   *   // ç­‰ç­‰...
   *
   *   // å¦‚æœå‡½æ•°å…·æœ‰è¿”å›å¯¹è±¡çš„ return è¯­å¥ï¼Œ
   *   // åˆ™è¯¥å¯¹è±¡å°†æ˜¯ new è¡¨è¾¾å¼çš„ç»“æœã€‚
   *   // å¦åˆ™ï¼Œè¡¨è¾¾å¼çš„ç»“æœæ˜¯å½“å‰ç»‘å®šåˆ° this çš„å¯¹è±¡ã€‚
   *   //ï¼ˆå³é€šå¸¸çœ‹åˆ°çš„å¸¸è§æƒ…å†µï¼‰ã€‚
   * }
   */
  
  function C(){
    this.a = 37;
  }
  
  var o = new C();
  console.log(o.a); // logs 37
  
  
  function C2(){
    this.a = 37;
    return {a:38};
  }
  
  o = new C2();
  console.log(o.a); // logs 38
  
  ```

  ğŸ¦ˆåˆ›å»ºå‡½æ•°Cï¼Œå…¶æ²¡æœ‰è¿”å›å€¼ï¼Œåœ¨thisä¸Šåˆ›å»ºå±æ€§aå¹¶èµ‹å€¼ï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºCçš„å®ä¾‹æ—¶ï¼Œè¾“å‡ºçš„å±æ€§aå°±å°±æ˜¯å‡½æ•°Cçš„å±æ€§ã€‚C2å‡½æ•°ç”±è¿”å›å€¼ï¼Œåˆ™è¿”å›ç»™åˆ›å»ºçš„å®ä¾‹ï¼Œthisç»‘å®šåˆ°è¯¥è¿”å›å€¼ä¸Š

- ä½œä¸ºä¸€ä¸ªDOMäº‹ä»¶å¤„ç†å‡½æ•°

  å½“å‡½æ•°è¢«ç”¨ä½œäº‹ä»¶å¤„ç†å‡½æ•°æ—¶ï¼Œå®ƒçš„ `this` æŒ‡å‘è§¦å‘äº‹ä»¶çš„å…ƒç´ 

- ä½œä¸ºå†…è”äº‹ä»¶å¤„ç†å‡½æ•°

  å½“ä»£ç è¢«å†…è” [on-event å¤„ç†å‡½æ•° (en-US)](https://developer.mozilla.org/en-US/docs/Web/Events/Event_handlers) è°ƒç”¨æ—¶ï¼Œå®ƒçš„`this`æŒ‡å‘ç›‘å¬å™¨æ‰€åœ¨çš„ DOM å…ƒç´ ï¼š

- ç±»ä¸­çš„this

  è®©ç±»ä¸­çš„ `this` å€¼æ€»æ˜¯æŒ‡å‘è¿™ä¸ªç±»å®ä¾‹ã€‚

  ```js
  class Car {
    constructor() {
      // Bind sayBye but not sayHi to show the difference
      this.sayBye = this.sayBye.bind(this);
    }
    sayHi() {
      console.log(`Hello from ${this.name}`);
    }
    sayBye() {
      console.log(`Bye from ${this.name}`);
    }
    get name() {
      return 'Ferrari';
    }
  }
  
  class Bird {
    get name() {
      return 'Tweety';
    }
  }
  
  const car = new Car();
  const bird = new Bird();
  
  // The value of 'this' in methods depends on their caller
  car.sayHi(); // Hello from Ferrari
  bird.sayHi = car.sayHi;
  bird.sayHi(); // Hello from Tweety
  
  // For bound methods, 'this' doesn't depend on the caller
  bird.sayBye = car.sayBye;
  bird.sayBye();  // Bye from Ferrari
  ```

